<!DOCTYPE html>
<html lang="sk">
<head>
<style>
    :root { 
        --primary: #1a237e; --secondary: #304ffe; --accent: #00e676; 
        --bg: #e3f2fd; --text: #333; --white: #fff; --danger: #d32f2f;
        --gray-light: #e0e0e0; --warning: #ffc107; --backup-color: #ff9800;
        --filter-active: #2e7d32; --filter-inactive: #ffffff;
        --card-yellow: #fbc02d; --card-red: #d32f2f;
        --border-radius: 16px;
    }
    
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#1a237e">
    <link rel="manifest" href="manifest.json">
    body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 20px; line-height: 1.5; }
    .container { max-width: 1500px; margin: 0 auto; position: relative; }
    
    /* HEADER SECTION */
    .main-header { text-align: center; margin-bottom: 20px; position: relative; z-index: 1; }
    .league-title { font-size: 72px; font-weight: 900; color: var(--primary); text-transform: uppercase; letter-spacing: -2px; margin: 0; line-height: 0.9; }
    .version-tag { font-size: 18px; color: #777; display: block; margin-top: 5px; font-weight: 600; }
    .sub-title { color: #555; font-size: 20px; margin-top: 5px; font-weight: 400; }
    
    .pro-gear-btn { position: absolute; left: 0; top: 10px; font-size: 52px; cursor: pointer; color: var(--primary); transition: 0.3s; z-index: 10; }
    .pro-gear-btn:hover { transform: rotate(90deg) scale(1.1); color: var(--secondary); }
    .gear-btn { position: absolute; right: 0; top: 10px; font-size: 32px; cursor: pointer; color: #555; transition: 0.3s; }
    .gear-btn:hover { color: var(--primary); transform: rotate(90deg); }

    /* SEARCH SECTION */
    .search-wrapper { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; padding: 0 5px; position: relative; z-index: 2; }
    .search-box { position: relative; }
    .search-input { width: 100%; padding: 18px 25px; border-radius: 12px; border: 2px solid #ddd; font-size: 20px; font-weight: 600; outline: none; transition: 0.3s; box-sizing: border-box; }
    .search-input:focus { border-color: var(--secondary); box-shadow: 0 0 10px rgba(48, 79, 254, 0.2); }
    .search-results { position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000; margin-top: 5px; max-height: 400px; overflow-y: auto; display: none; }
    .search-item { padding: 15px 25px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 18px; font-weight: bold; transition: 0.2s; }
    .search-item:hover { background: #f0f4ff; color: var(--secondary); }

    /* FILTER TOGGLE BUTTON - V.2.41.1 */
    .filter-toggle-btn {
        width: 100%; background: var(--white); border: 2px solid #ddd; padding: 12px; border-radius: 12px; margin-bottom: 15px;
        cursor: pointer; font-size: 18px; font-weight: 800; color: var(--primary); transition: 0.3s; text-align: center;
        display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .filter-toggle-btn:hover { background: #f8fbff; border-color: var(--secondary); }
    .filter-toggle-btn.active { background: var(--primary); color: white; border-color: var(--primary); }

    /* TABLE STYLES */
    .main-wrapper { background: var(--white); border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; border: 1px solid rgba(0,0,0,0.05); }
    .filter-panel { background: #f8f9fa; padding: 25px; border-bottom: 2px solid #eee; display: none; /* Predvolene skryté */ }
    .filter-group { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px dashed #ddd; text-align: center; }
    
    .grid-seasons { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; max-width: 1000px; margin: 10px auto; }
    .grid-clubs { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; max-width: 1000px; margin: 10px auto; }
    .grid-positions { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; max-width: 1000px; margin: 10px auto; }
    .full-width-filter { width: 100%; max-width: 1000px; margin: 0 auto 10px auto; }

    .filter-btn { padding: 12px 10px; border: 1px solid #ced4da; background: var(--filter-inactive); border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 700; transition: all 0.2s; user-select: none; width: 100%; text-align: center; color: #444; }
    .filter-btn.active { background: var(--filter-active) !important; color: white !important; border-color: var(--filter-active); box-shadow: 0 4px 8px rgba(46, 125, 50, 0.3); }
    .filter-btn.empty-slot { background: #fee; color: #c62828; border: 1px dashed #ef9a9a; cursor: default; font-weight: 400; opacity: 0.7; }

    .data-table { width: 100%; border-collapse: collapse; font-size: 22px; table-layout: fixed; background: white; }
    .data-table th { background: var(--primary); color: var(--white); padding: 15px 5px; position: sticky; top: 0; z-index: 5; }
    .data-table td { padding: 15px 10px; border-bottom: 1px solid #f0f0f0; text-align: center; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .data-table tr:hover { background: #f8fbff; }
    .data-table td:first-child { text-align: left; padding-left: 20px; }

    .sort-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 2px; }
    .sort-label { font-size: 32px; font-weight: 900; line-height: 1; text-transform: uppercase; letter-spacing: -1px; }
    .arrow-btn { background: rgba(255,255,255,0.15); width: 30px; height: 20px; display: flex; align-items: center; justify-content: center; border-radius: 4px; cursor: pointer; transition: 0.2s; font-size: 14px; }
    .arrow-btn:hover { background: var(--accent); color: var(--primary); }
    .clickable { color: var(--secondary); cursor: pointer; font-weight: 700; transition: 0.2s; }
    .clickable:hover { color: var(--primary); text-decoration: underline; }
    .stat-yc { color: #f9a825; font-weight: 900; }
    .stat-rc { color: #c62828; font-weight: 900; }
    .stat-goals { color: var(--primary); font-weight: 900; }

    /* MODALS */
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); justify-content: center; align-items: center; backdrop-filter: blur(5px); z-index: 3000; }
    .modal-content { background: white; padding: 40px; border-radius: 20px; width: 96%; max-width: 1400px; max-height: 92vh; overflow-y: auto; position: relative; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
    .close-btn { position: sticky; float: right; right: 0; top: -15px; font-size: 120px; cursor: pointer; color: #000; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; z-index: 3100; font-weight: 900; -webkit-text-stroke: 6px black; line-height: 1; margin-bottom: -100px; }
    .close-btn:hover { color: var(--danger); -webkit-text-stroke: 6px var(--danger); }

    .player-top-menu { background: linear-gradient(135deg, var(--primary), var(--secondary)); margin: -40px -40px 30px -40px; padding: 40px 20px; color: white; text-align: center; }
    .player-name-big { font-size: 55px; text-transform: uppercase; margin: 0; font-weight: 900; letter-spacing: -1px; line-height: 1; }
    .current-club-info { font-size: 36px; font-weight: 900; color: var(--warning); margin-top: 5px; cursor: pointer; text-shadow: 0 2px 4px rgba(0,0,0,0.3); transition: 0.2s; display: inline-block; border-bottom: 2px solid transparent; }
    .current-club-info:hover { color: var(--white); border-bottom-color: var(--white); transform: scale(1.05); }
    .player-positions-header { font-size: 20px; color: #b3e5fc; margin-top: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
    .player-attributes { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; margin-top: 25px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px; }
    .attr-box { text-align: center; }
    .attr-label { font-size: 14px; opacity: 0.8; text-transform: uppercase; display: block; }
    .attr-value { font-size: 24px; font-weight: 800; }
    
    .detail-table { width: 100%; border-collapse: collapse; font-size: 20px; margin-top: 20px; }
    .detail-table th, .detail-table td { padding: 12px; border-bottom: 1px solid #eee; text-align: center; }
    .detail-table th { background: #eee; color: #444; }

    .club-header-title { text-align:center; font-size: 50px; text-transform: uppercase; color: var(--primary); margin-bottom: 20px; font-weight: 900; }
    .club-stat-row { background: #fff; border: 1px solid #eee; padding: 15px; margin-bottom: 8px; border-radius: 12px; display: grid; grid-template-columns: 2.5fr 1fr 0.8fr 0.8fr 0.8fr 0.8fr 0.8fr; gap: 10px; align-items: center; font-size: 20px; }
    .club-stat-header { background: var(--primary); color: white; font-weight: 900; }
    
    .btn-big-circle { background: var(--accent); color: white; font-size: 60px; width: 120px; height: 120px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 6px 15px rgba(0,0,0,0.15); transition: 0.2s; }
    .btn-hamburger { background: var(--primary); font-weight: bold; line-height: 0.7; }
    .btn-backup { background: var(--backup-color); font-size: 60px; }
    .action-circle-container { display: flex; justify-content: center; gap: 40px; margin-bottom: 30px; flex-wrap: wrap; }
    
    .pro-menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 30px; width: 100%; }
    .slot-card { min-height: 250px; border-radius: 20px; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: 0.3s; color: white; padding: 20px; }
    .slot-card.empty { background: #eceff1; color: #90a4ae; border: 3px dashed #cfd8dc; }
    .slot-card.filled { background: linear-gradient(135deg, #2e7d32, #43a047); box-shadow: 0 8px 20px rgba(46,125,50,0.3); }
    .btn-slot-main { padding: 15px; border-radius: 12px; font-size: 24px; font-weight: 900; text-align: center; cursor: pointer; text-transform: uppercase; background: rgba(255,255,255,0.2); border: 2px solid white; margin: 5px; flex: 1; }
    .slot-sub-actions { display: flex; gap: 15px; margin-top: 15px; }
    .btn-slot-sub { font-size: 30px; cursor: pointer; }

    .backup-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; }
    .backup-item { background: #fff3e0; border: 2px solid #ffe0b2; padding: 15px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 20px; color: #e65100; }
    
    .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; padding: 20px; }
    .settings-box { border: 2px dashed #ccc; padding: 20px; border-radius: 15px; text-align: center; }
    .table-footer { text-align: center; padding: 20px; color: #777; font-weight: 600; }
</style>
</head>
<body>

<div class="container">
    <div class="pro-gear-btn" onclick="openModal('proMenuModal')">⚙️</div>
    
    <div class="main-header">
        <h1 class="league-title">NIKE LIGA Pro</h1>
        <span class="version-tag">v.2.41.1 (Dynamic Edition)</span>
        <div class="sub-title">Elite Stats Management System ⚽</div>
        <div class="gear-btn" onclick="openModal('settingsModal')">⚙️</div>
    </div>

    <div class="search-wrapper">
        <div class="search-box">
            <input type="text" id="playerSearch" class="search-input" placeholder="🔍 Vyhľadať hráča..." oninput="handleSearch('player')">
            <div id="playerResults" class="search-results"></div>
        </div>
        <div class="search-box">
            <input type="text" id="clubSearch" class="search-input" placeholder="🛡️ Vyhľadať klub..." oninput="handleSearch('club')">
            <div id="clubResults" class="search-results"></div>
        </div>
    </div>

    <div id="filterToggleBtn" class="filter-toggle-btn" onclick="toggleFilterPanel()">
        <span>🔍 ZOBRAZIŤ FILTRE</span>
    </div>

    <div class="main-wrapper">
        <div id="filterPanel" class="filter-panel">
            <div class="filter-group"><div id="seasonAllContainer" class="full-width-filter"></div><div id="seasonFilters" class="grid-seasons"></div></div>
            <div class="filter-group"><div id="clubAllContainer" class="full-width-filter"></div><div id="clubFilters" class="grid-clubs"></div></div>
            <div class="filter-group"><div id="posAllContainer" class="full-width-filter"></div><div id="posFilters" class="grid-positions"></div></div>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 24%;"><div class="sort-wrapper"><div class="arrow-btn" onclick="handleSort('name', 'asc')">▲</div><div class="sort-label">Meno</div><div class="arrow-btn" onclick="handleSort('name', 'desc')">▼</div></div></th>
                    <th style="width: 18%;"><div class="sort-wrapper"><div class="arrow-btn" onclick="handleSort('clubs_str', 'asc')">▲</div><div class="sort-label">Klub</div><div class="arrow-btn" onclick="handleSort('clubs_str', 'desc')">▼</div></div></th>
                    <th style="width: 12%;"><div class="sort-wrapper"><div class="arrow-btn" onclick="handleSort('pos', 'asc')">▲</div><div class="sort-label">Poz</div><div class="arrow-btn" onclick="handleSort('pos', 'desc')">▼</div></div></th>
                    <th style="width: 8%;"><div class="sort-wrapper"><div class="arrow-btn" onclick="handleSort('apps', 'asc')">▲</div><div class="sort-label">Z</div><div class="arrow-btn" onclick="handleSort('apps', 'desc')">▼</div></div></th>
                    <th style="width: 8%;"><div class="sort-wrapper"><div class="arrow-btn" onclick="handleSort('goals', 'asc')">▲</div><div class="sort-label">G</div><div class="arrow-btn" onclick="handleSort('goals', 'desc')">▼</div></div></th>
                    <th style="width: 8%;"><div class="sort-wrapper"><div class="arrow-btn" onclick="handleSort('assists', 'asc')">▲</div><div class="sort-label">A</div><div class="arrow-btn" onclick="handleSort('assists', 'desc')">▼</div></div></th>
                    <th style="width: 8%; background: #fbc02d; color:#333"><div class="sort-wrapper"><div class="arrow-btn" onclick="handleSort('yc', 'asc')">▲</div><div class="sort-label">ŽK</div><div class="arrow-btn" onclick="handleSort('yc', 'desc')">▼</div></div></th>
                    <th style="width: 8%; background: #d32f2f;"><div class="sort-wrapper"><div class="arrow-btn" onclick="handleSort('rc', 'asc')">▲</div><div class="sort-label">ČK</div><div class="arrow-btn" onclick="handleSort('rc', 'desc')">▼</div></div></th>
                </tr>
            </thead>
            <tbody id="mainTableBody"></tbody>
        </table>
        <div class="table-footer"><span class="brand-text">(Arciweb) EA FC25 stats keeper for Nike liga v.2.41.1 | all right reserves</span></div>
    </div>
</div>

<div id="proMenuModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('proMenuModal')">&times;</span>
        <h2 style="text-align: center; font-size: 45px; margin-bottom: 40px; color: var(--primary);">PRO MANAGER MENU</h2>
        <div class="action-circle-container">
            <div style="text-align:center"><div class="btn-big-circle btn-backup" onclick="openModal('backupModal')">💾</div><p style="font-weight:900; margin-top:15px; font-size: 20px;">ZÁLOHA</p></div>
            <div style="text-align:center"><div class="btn-big-circle btn-hamburger" onclick="openDocManager()">_ <br> _ <br> _</div><p style="font-weight:900; margin-top:15px; font-size: 20px;">SPRÁVCA TXT</p></div>
            <div style="text-align:center"><div class="btn-big-circle btn-info" onclick="openModal('infoModal')">👁</div><p style="font-weight:900; margin-top:15px; font-size: 20px;">INFO</p></div>
        </div>
        <div class="pro-menu-grid" id="proSlotsContainer"></div>
    </div>
</div>

<div id="backupModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('backupModal')">&times;</span>
        <h2 style="text-align: center; font-size: 45px; color: var(--backup-color); margin-bottom: 30px;">ZÁLOHA A KONVERZIA</h2>
        <div style="text-align:center; margin-bottom:40px; padding: 30px; border: 3px dashed #ccc; border-radius: 20px;">
            <p style="font-size: 24px; font-weight: bold; color: #555; margin-bottom: 20px;">Nahrať nový formát TXT (12+ štatistík)</p>
            <label for="backupInput" class="btn-big-circle btn-backup" style="margin: 0 auto; width: 150px; height: 150px; font-size: 80px;">💾</label>
            <input type="file" id="backupInput" accept=".txt" style="display:none">
        </div>
        <h3 style="font-size: 30px; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px;">Vytvorené zálohy (Data files)</h3>
        <div id="backupListContainer" class="backup-list"></div>
    </div>
</div>

<div id="infoModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px;">
        <span class="close-btn" onclick="closeModal('infoModal')">&times;</span>
        <div class="info-box" style="text-align:center">
            <h2>NIKE LIGA PRO by Arči</h2>
            <a href="https://cmtracker.net/" target="_blank" style="font-size:30px; color:var(--secondary)">https://cmtracker.net/</a>
            <p>(Arciweb) EA FC25 stats keeper v.2.41.1</p>
        </div>
    </div>
</div>

<div id="docManagerModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('docManagerModal')">&times;</span>
        <h2 style="text-align: center; font-size: 45px; color: var(--primary); margin-bottom: 30px;">SPRÁVCA DOKUMENTOV</h2>
        <div id="docManagerList"></div>
    </div>
</div>

<div id="settingsModal" class="modal-overlay">
    <div class="modal-content">
        <span class="close-btn" onclick="closeModal('settingsModal')">&times;</span>
        <h2 style="text-align:center; font-size: 40px; margin-bottom:30px">Nastavenia</h2>
        <div class="settings-grid">
            <div class="settings-box">
                <p style="font-size:20px; font-weight:bold">Pridať Klasický TXT</p>
                <label for="proFileInput" class="btn-big-circle" style="margin: 0 auto;">+</label>
                <input type="file" id="proFileInput" multiple accept=".txt" style="display:none">
            </div>
            <div class="settings-box" style="border-color: var(--danger);">
                <p style="font-size:20px; font-weight:bold; color:var(--danger)">DANGER ZONE</p>
                <button class="filter-btn" style="background:var(--danger); color:white; padding: 25px; font-size: 24px; border:none; border-radius: 15px; width: auto;" onclick="resetAll()">VYMAZAŤ DATABÁZU</button>
            </div>
        </div>
    </div>
</div>

<div id="multiClubModal" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px;">
        <span class="close-btn" onclick="closeModal('multiClubModal')">&times;</span>
        <h2 style="text-align:center; font-size: 35px; color: var(--primary);">ZOZNAM KLUBOV</h2>
        <div id="multiClubContent" style="display:flex; flex-direction:column; gap:10px"></div>
    </div>
</div>

<input type="file" id="slotUploadInput" accept=".txt" style="display:none">

<script>
    const POS_ORDER = {"GK":1, "CB":2, "LB":3, "RB":4, "CDM":5, "CM":6, "CAM":7, "LM":8, "RM":9, "LW":10, "RW":11, "ST":12};
    const FIXED_CLUBS = ["Zilina", "Slovan", "Trnava", "D.Streda", "Trencin", "Kosice", "Ruzomberok", "Komarno", "Podbrezova", "B.Bystrica", "Skalica", "Michalovce"];
    
    let appData = { players: {}, seasons: [], externalLink: "", backups: {} };
    let filters = { seasons: new Set(['all']), clubs: new Set(['all']), positions: new Set(['all']) };
    let currentSort = { key: 'goals', dir: 'desc' };
    let modalStack = []; 
    let maxZ = 9000; // Počiatočná hodnota pre z-index
    
    let pmSort = { key: 'season', dir: 'asc' };
    let cmSort = { key: 'goals', dir: 'desc' }; 
    let pmClubFilter = 'all';
    let currentUploadSlot = null;

    // --- LOGIKA FILTROV V.2.41.1 ---
    function toggleFilterPanel() {
        const panel = document.getElementById('filterPanel');
        const btn = document.getElementById('filterToggleBtn');
        if (panel.style.display === 'block') {
            panel.style.display = 'none';
            btn.innerHTML = '<span>🔍 ZOBRAZIŤ FILTRE</span>';
            btn.classList.remove('active');
        } else {
            panel.style.display = 'block';
            btn.innerHTML = '<span>▲ ZABALIŤ FILTRE</span>';
            btn.classList.add('active');
        }
    }

    // --- MODAL SYSTÉM S DYNAMICKÝM Z-INDEXOM ---
    function openModal(id) { 
        maxZ++;
        const modal = document.getElementById(id);
        modal.style.display = 'flex'; 
        modal.style.zIndex = maxZ;
        
        if(id === 'backupModal') renderBackups();
        pushState(); 
    }

    function closeModal(id) { 
        if(id.includes('dynamic')) closeTopModal();
        else window.history.back(); 
    }

    function openDynamicModal(type, id) {
        if(modalStack.length >= 10) return;
        maxZ++;
        const modalId = `dynamic-modal-${modalStack.length}`;
        const modalDiv = document.createElement('div');
        modalDiv.className = 'modal-overlay dynamic-modal';
        modalDiv.id = modalId;
        modalDiv.style.display = 'flex';
        modalDiv.style.zIndex = maxZ;
        
        let contentHTML = (type === 'player') ? buildPlayerModalHTML(id, modalId) : buildClubModalHTML(id, modalId);
        modalDiv.innerHTML = `<div class="modal-content" style="${type==='player'?'padding:0':''}"><span class="close-btn" onclick="closeTopModal()">&times;</span>${contentHTML}</div>`;
        document.body.appendChild(modalDiv);
        modalStack.push({ id: modalId, type: type, dataId: id });
        
        if(type === 'player') renderPlayerStats(id, modalId);
        if(type === 'club') renderClubStats(id, modalId);
        pushState();
    }

    function closeTopModal() {
        if(modalStack.length === 0) return;
        const top = modalStack.pop();
        const el = document.getElementById(top.id);
        if(el) el.remove();
    }

    // --- OSTATNÁ LOGIKA (POUCHAL SOM POVODNU) ---
    function pushState() {
        const state = {
            filters: { seasons: Array.from(filters.seasons), clubs: Array.from(filters.clubs), positions: Array.from(filters.positions) },
            sort: currentSort,
            stackSize: modalStack.length
        };
        history.pushState(state, "");
    }

    function parseMoney(val) {
        if (!val || val === '-') return 0;
        let str = val.toString().toUpperCase().replace(/€/g, '').replace(/ /g, '').replace(/,/g, '.');
        let multiplier = 1;
        if (str.includes('M')) { multiplier = 1000000; str = str.replace('M', ''); }
        else if (str.includes('K')) { multiplier = 1000; str = str.replace('K', ''); }
        let number = parseFloat(str);
        return isNaN(number) ? 0 : Math.round(number * multiplier);
    }
    
    function formatMoney(val) {
        if(!val) return "-";
        if(val >= 1000000) return (val/1000000).toFixed(val % 1000000 === 0 ? 0 : 1) + "M €";
        if(val >= 1000) return (val/1000).toFixed(0) + "K €";
        return val + " €";
    }

    function parseFoot(val) {
        if (!val) return "-";
        if (val.toLowerCase().includes('left')) return "L";
        if (val.toLowerCase().includes('right')) return "R";
        return val;
    }

    function getLatestPlayerInfo(name) {
        const p = appData.players[name];
        if(!p || p.history.length === 0) return {};
        return [...p.history].sort((a,b) => b.season.localeCompare(a.season))[0];
    }
    
    function getAllPlayerPositions(name) {
        const p = appData.players[name]; if (!p) return "";
        let posSet = new Set();
        p.history.forEach(h => h.pos.split(' ').forEach(po => { if(po !== '-') posSet.add(po) }));
        return Array.from(posSet).sort((a,b) => (POS_ORDER[a]||99) - (POS_ORDER[b]||99)).join(', ');
    }

    function buildPlayerModalHTML(playerName, domId) {
        const info = getLatestPlayerInfo(playerName);
        const lastClub = info.club || "Neznáme";
        return `<div class="player-top-menu">
            <h2 class="player-name-big clickable" onclick="openExternalLink()">${playerName}</h2>
            <div class="current-club-info" onclick="openDynamicModal('club', '${lastClub}')">${lastClub}</div>
            <div class="player-positions-header">${getAllPlayerPositions(playerName)}</div>
            <div class="player-attributes">
                <div class="attr-box"><span class="attr-label">VEK</span><span class="attr-value">${info.age || '-'}</span></div>
                <div class="attr-box"><span class="attr-label">OVR</span><span class="attr-value">${info.ovr || '-'}</span></div>
                <div class="attr-box"><span class="attr-label">VÝŠKA</span><span class="attr-value">${info.height || '-'}</span></div>
                <div class="attr-box"><span class="attr-label">VÁHA</span><span class="attr-value">${info.weight || '-'}</span></div>
                <div class="attr-box"><span class="attr-label">NOHA</span><span class="attr-value">${info.foot || '-'}</span></div>
                <div class="attr-box"><span class="attr-label">CENA</span><span class="attr-value" style="color:#a5d6a7">${formatMoney(info.price)}</span></div>
                <div class="attr-box"><span class="attr-label">PLAT</span><span class="attr-value" style="color:#a5d6a7">${formatMoney(info.wage)}</span></div>
            </div>
        </div>
        <div style="padding: 0 40px 40px 40px"><div class="player-filter-bar" id="${domId}-filters"></div><div id="${domId}-content"></div></div>`;
    }

    function buildClubModalHTML(clubName, domId) {
        return `<h2 class="club-header-title">${clubName}</h2>
        <div class="club-stat-row club-stat-header">
            <div onclick="updateCmSort('${domId}', '${clubName}', 'name')" style="cursor:pointer">Meno ↕</div>
            <div>Poz.</div>
            <div onclick="updateCmSort('${domId}', '${clubName}', 'apps')" style="cursor:pointer">Z ↕</div>
            <div onclick="updateCmSort('${domId}', '${clubName}', 'goals')" style="cursor:pointer">G ↕</div>
            <div onclick="updateCmSort('${domId}', '${clubName}', 'assists')" style="cursor:pointer">A ↕</div>
            <div onclick="updateCmSort('${domId}', '${clubName}', 'yc')" style="cursor:pointer">ŽK ↕</div>
            <div onclick="updateCmSort('${domId}', '${clubName}', 'rc')" style="cursor:pointer">ČK ↕</div>
        </div>
        <div id="${domId}-content"></div>`;
    }

    window.onpopstate = (e) => {
        document.querySelectorAll('.modal-overlay:not(.dynamic-modal)').forEach(m => m.style.display = 'none');
        if(e.state) {
            filters = { seasons: new Set(e.state.filters.seasons), clubs: new Set(e.state.filters.clubs), positions: new Set(e.state.filters.positions) };
            currentSort = e.state.sort;
            if(modalStack.length > e.state.stackSize) {
                const diff = modalStack.length - e.state.stackSize;
                for(let i=0; i<diff; i++) closeTopModal();
            }
            renderAll(false);
        } else {
            modalStack.forEach(m => { const el = document.getElementById(m.id); if(el) el.remove(); });
            modalStack = [];
            renderAll(false);
        }
    };

    function renderPlayerStats(playerName, domId) {
        const p = appData.players[playerName];
        const uniqueClubs = ['all', ...new Set(p.history.map(h => h.club || "Neznáme"))];
        const filterContainer = document.getElementById(`${domId}-filters`);
        filterContainer.innerHTML = uniqueClubs.map(c => `<div class="filter-btn ${pmClubFilter === c ? 'active' : ''}" style="width:auto; min-width:140px" onclick="setPmClubFilter('${domId}', '${playerName}', '${c}')">${c.toUpperCase()}</div>`).join('');
        let fil = p.history.filter(h => pmClubFilter === 'all' || (h.club || "Neznáme") === pmClubFilter);
        fil.sort((a, b) => {
            let v1 = a[pmSort.key], v2 = b[pmSort.key];
            if (pmSort.key === 'season' || pmSort.key === 'club') return pmSort.dir === 'asc' ? v1.localeCompare(v2) : v2.localeCompare(v1);
            return pmSort.dir === 'asc' ? v1 - v2 : v2 - v1;
        });
        let t = { z: 0, g: 0, a: 0, yc: 0, rc: 0 };
        let h = `<table class="detail-table"><thead><tr><th onclick="updatePmSort('${domId}','${playerName}','season')">Sezóna ↕</th><th onclick="updatePmSort('${domId}','${playerName}','club')">Klub ↕</th><th>Poz.</th><th onclick="updatePmSort('${domId}','${playerName}','apps')">Z ↕</th><th onclick="updatePmSort('${domId}','${playerName}','goals')">G ↕</th><th onclick="updatePmSort('${domId}','${playerName}','assists')">A ↕</th><th onclick="updatePmSort('${domId}','${playerName}','yc')">ŽK ↕</th><th onclick="updatePmSort('${domId}','${playerName}','rc')">ČK ↕</th></tr></thead><tbody>`;
        fil.forEach(x => { 
            t.z += x.apps; t.g += x.goals; t.a += x.assists; t.yc += (x.yc||0); t.rc += (x.rc||0);
            h += `<tr><td>${x.season}</td><td class="clickable" onclick="openDynamicModal('club', '${x.club}')">${x.club}</td><td>${x.pos}</td><td>${x.apps}</td><td class="stat-goals">${x.goals}</td><td>${x.assists}</td><td class="stat-yc">${x.yc||0}</td><td class="stat-rc">${x.rc||0}</td></tr>`; 
        });
        document.getElementById(`${domId}-content`).innerHTML = h + `<tr style="font-weight:900; background:#e3f2fd; color:var(--primary)"><td colspan="3">SUMÁR</td><td>${t.z}</td><td>${t.g}</td><td>${t.a}</td><td>${t.yc}</td><td>${t.rc}</td></tr></tbody></table>`;
    }

    function setPmClubFilter(domId, playerName, c) { pmClubFilter = c; renderPlayerStats(playerName, domId); }
    function updatePmSort(domId, playerName, key) {
        if(pmSort.key === key) pmSort.dir = (pmSort.dir === 'asc' ? 'desc' : 'asc');
        else { pmSort.key = key; pmSort.dir = 'desc'; }
        renderPlayerStats(playerName, domId);
    }

    function renderClubStats(clubName, domId) {
        let list = []; 
        Object.values(appData.players).forEach(p => { 
            let ch = p.history.filter(h => h.club === clubName); 
            if (ch.length > 0) { 
                let s = { name: p.name, apps: 0, goals: 0, assists: 0, yc: 0, rc: 0, pos: ch[ch.length-1].pos }; 
                ch.forEach(x => { s.apps+=x.apps; s.goals+=x.goals; s.assists+=x.assists; s.yc+=(x.yc||0); s.rc+=(x.rc||0); }); 
                list.push(s); 
            } 
        });
        list.sort((a,b) => cmSort.dir === 'desc' ? (b[cmSort.key] > a[cmSort.key] ? 1 : -1) : (a[cmSort.key] > b[cmSort.key] ? 1 : -1));
        document.getElementById(`${domId}-content`).innerHTML = list.map(i => `
            <div class="club-stat-row">
                <span class="clickable" onclick="openDynamicModal('player', '${i.name}')">${i.name}</span>
                <span>${i.pos}</span><span>${i.apps}</span><span class="stat-goals">${i.goals}</span><span>${i.assists}</span><span class="stat-yc">${i.yc}</span><span class="stat-rc">${i.rc}</span>
            </div>`).join('');
    }
    function updateCmSort(domId, clubName, key) {
        if(cmSort.key === key) cmSort.dir = (cmSort.dir === 'asc' ? 'desc' : 'asc');
        else { cmSort.key = key; cmSort.dir = 'desc'; }
        renderClubStats(clubName, domId);
    }

    function renderTable() {
        const tbody = document.getElementById('mainTableBody'); tbody.innerHTML = '';
        let list = [];
        Object.values(appData.players).forEach(p => {
            let res = { name: p.name, apps: 0, goals: 0, assists: 0, yc: 0, rc: 0, clubs: new Set(), pos: new Set(), pos_primary: '', match: false };
            p.history.forEach(h => {
                if ((filters.seasons.has('all') || filters.seasons.has(h.season)) && (filters.clubs.has('all') || filters.clubs.has(h.club)) && (filters.positions.has('all') || h.pos.split(' ').some(hp => filters.positions.has(hp)))) {
                    res.apps += h.apps; res.goals += h.goals; res.assists += h.assists;
                    res.yc += (h.yc || 0); res.rc += (h.rc || 0);
                    if(h.club && h.club !== "Neznáme") res.clubs.add(h.club);
                    h.pos.split(' ').forEach(po => res.pos.add(po));
                    if(!res.pos_primary && h.pos !== "-") res.pos_primary = h.pos.split(' ')[0];
                    res.match = true;
                }
            });
            if (res.match) { res.clubs_str = Array.from(res.clubs).join(', '); list.push(res); }
        });
        list.sort((a,b) => {
            let v1 = a[currentSort.key], v2 = b[currentSort.key];
            if (currentSort.key === 'name') { v1 = v1.split(' ').pop(); v2 = v2.split(' ').pop(); return currentSort.dir === 'desc' ? v2.localeCompare(v1) : v1.localeCompare(v2); }
            if (currentSort.key === 'pos') { v1 = POS_ORDER[a.pos_primary] || 99; v2 = POS_ORDER[b.pos_primary] || 99; }
            return currentSort.dir === 'desc' ? (v2 > v1 ? 1 : -1) : (v1 > v2 ? 1 : -1);
        });
        list.forEach(i => {
            let clubsDisplay = i.clubs.size >= 3 ? `<span class="clickable" onclick="openMultiClubModal('${i.name}')">Viac klubov</span>` : Array.from(i.clubs).map(c => `<span class="clickable" onclick="openDynamicModal('club', '${c}')">${c}</span>`).join(', ');
            tbody.innerHTML += `<tr><td class="clickable" onclick="openDynamicModal('player', '${i.name}')">${i.name}</td><td>${clubsDisplay || "Neznáme"}</td><td>${Array.from(i.pos).join(', ')}</td><td>${i.apps}</td><td class="stat-goals">${i.goals}</td><td>${i.assists}</td><td class="stat-yc">${i.yc}</td><td class="stat-rc">${i.rc}</td></tr>`;
        });
    }

    window.onload = () => {
        const saved = localStorage.getItem('fifa_pro_data');
        if(saved) { appData = JSON.parse(saved); if(!appData.backups) appData.backups = {}; }
        renderAll();
        document.addEventListener('click', (e) => { if (!e.target.closest('.search-box')) { document.getElementById('playerResults').style.display = 'none'; document.getElementById('clubResults').style.display = 'none'; } });
    };

    function handleSearch(type) {
        const inputId = type === 'player' ? 'playerSearch' : 'clubSearch';
        const resultsId = type === 'player' ? 'playerResults' : 'clubResults';
        const query = document.getElementById(inputId).value.toLowerCase().trim();
        const resultsDiv = document.getElementById(resultsId);
        if (query === "") { resultsDiv.style.display = 'none'; return; }
        let matches = (type === 'player') ? Object.keys(appData.players).filter(name => name.toLowerCase().includes(query)).sort() : FIXED_CLUBS.filter(club => club.toLowerCase().includes(query)).sort();
        if (matches.length > 0) { resultsDiv.innerHTML = matches.map(m => `<div class="search-item" onclick="selectSearchItem('${type}', '${m}')">${m}</div>`).join(''); resultsDiv.style.display = 'block'; } else resultsDiv.style.display = 'none';
    }

    function selectSearchItem(type, value) {
        if (type === 'player') openDynamicModal('player', value); else openDynamicModal('club', value);
        document.getElementById(type + 'Search').value = ''; document.getElementById(type + 'Results').style.display = 'none';
    }

    function handleSort(key, dir) { currentSort.key = key; currentSort.dir = dir; renderTable(); }
    
    function toggleFilter(k, v) {
        if (v === 'all') { filters[k].clear(); filters[k].add('all'); }
        else { filters[k].delete('all'); filters[k].has(v) ? filters[k].delete(v) : filters[k].add(v); if (filters[k].size === 0) filters[k].add('all'); }
        renderAll();
    }

    function renderFilters() {
        document.getElementById('seasonAllContainer').innerHTML = `<div class="filter-btn all-btn ${filters.seasons.has('all')?'active':''}" onclick="toggleFilter('seasons','all')">VŠETKY SEZÓNY</div>`;
        const sDiv = document.getElementById('seasonFilters'); sDiv.innerHTML = '';
        const loadedSeasons = appData.seasons.slice().sort();
        for (let i = 1; i <= 15; i++) {
            const sn = loadedSeasons[i-1];
            if (sn) sDiv.innerHTML += `<div class="filter-btn ${filters.seasons.has(sn)?'active':''}" onclick="toggleFilter('seasons','${sn}')">${sn}</div>`;
            else sDiv.innerHTML += `<div class="filter-btn empty-slot">${i}. SEZÓNA</div>`;
        }
        document.getElementById('clubAllContainer').innerHTML = `<div class="filter-btn all-btn ${filters.clubs.has('all')?'active':''}" onclick="toggleFilter('clubs','all')">VŠETKY KLUBY</div>`;
        document.getElementById('clubFilters').innerHTML = FIXED_CLUBS.map(i => `<div class="filter-btn ${filters.clubs.has(i)?'active':''}" onclick="toggleFilter('clubs','${i}')">${i}</div>`).join('');
        document.getElementById('posAllContainer').innerHTML = `<div class="filter-btn all-btn ${filters.positions.has('all')?'active':''}" onclick="toggleFilter('positions','all')">VŠETKY POZÍCIE</div>`;
        document.getElementById('posFilters').innerHTML = Object.keys(POS_ORDER).map(i => `<div class="filter-btn ${filters.positions.has(i)?'active':''}" onclick="toggleFilter('positions','${i}')">${i}</div>`).join('');
    }

    function openMultiClubModal(playerName) {
        const p = appData.players[playerName];
        const uniqueClubs = new Set();
        p.history.forEach(h => { if ((filters.seasons.has('all') || filters.seasons.has(h.season)) && (filters.clubs.has('all') || filters.clubs.has(h.club))) { if(h.club && h.club !== "Neznáme") uniqueClubs.add(h.club); } });
        let content = `<ul class="multi-club-list" style="list-style:none; padding:0">`;
        Array.from(uniqueClubs).sort().forEach(c => { content += `<li onclick="openDynamicModal('club', '${c}')" style="background:#f0f4ff; padding:15px; margin-bottom:10px; border-radius:10px; font-weight:bold; cursor:pointer; text-align:center; border:1px solid #d0d7ff; color:var(--primary)">${c}</li>`; });
        document.getElementById('multiClubContent').innerHTML = content + `</ul>`;
        openModal('multiClubModal');
    }

    document.getElementById('backupInput').onchange = async (e) => {
        const file = e.target.files[0]; if (!file) return;
        const text = await file.text(); parseBackupTxt(text);
        e.target.value = ''; saveToLocal(); renderAll(); renderBackups();
    };

    function parseBackupTxt(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l !== "");
        if (lines.length < 3) return;
        let startIndex = 0; if (lines[0].startsWith('http')) { appData.externalLink = lines[0]; startIndex = 1; }
        const season = lines[startIndex]; if (!appData.seasons.includes(season)) appData.seasons.push(season);
        let outputContent = (appData.externalLink ? appData.externalLink + "\n" : "") + season + "\n";
        let currentClub = "Neznáme";
        for (let i = startIndex + 1; i < lines.length; i++) {
            if (lines[i].toLowerCase().includes('klub :')) { currentClub = lines[i].split(':')[1].trim() || "Neznáme"; outputContent += `Klub : ${currentClub}\n`; continue; }
            if (i + 13 < lines.length && (!isNaN(lines[i+2]) || lines[i+2] === '-')) {
                const name = lines[i], pos = lines[i+1], val_ovr = lines[i+2], val_apps = parseInt(lines[i+3]) || 0, val_goals = parseInt(lines[i+4]) || 0, val_assists = parseInt(lines[i+5]) || 0, val_yc = parseInt(lines[i+6]) || 0, val_rc = parseInt(lines[i+7]) || 0, val_age = lines[i+8], val_height = lines[i+9], val_weight = lines[i+10], val_foot = parseFoot(lines[i+11]), val_price = parseMoney(lines[i+12]), val_wage = parseMoney(lines[i+13]);
                if (!appData.players[name]) appData.players[name] = { name, history: [] };
                appData.players[name].history = appData.players[name].history.filter(h => h.season !== season);
                appData.players[name].history.push({ season, club: currentClub, pos, apps: val_apps, goals: val_goals, assists: val_assists, yc: val_yc, rc: val_rc, ovr: val_ovr, age: val_age, height: val_height, weight: val_weight, foot: val_foot, price: val_price, wage: val_wage });
                outputContent += `${name}\n${pos}\n${val_ovr}\n${val_apps||'-'}\n${val_goals||'-'}\n${val_assists||'-'}\n${val_yc}\n${val_rc}\n${val_age}\n${val_height}\n${val_weight}\n${val_foot}\n${val_price}\n${val_wage}\n`;
                i += 13; if (i + 1 < lines.length && lines[i+1].toUpperCase() === 'L') i++;
            }
        }
        appData.backups[`data${season}.txt`] = outputContent;
    }

    document.getElementById('proFileInput').onchange = async (e) => { for (let file of e.target.files) { const text = await file.text(); parseTxt(text); } saveToLocal(); renderAll(); closeModal('settingsModal'); };
    function parseTxt(text) {
        const lines = text.split('\n').map(l => l.trim()).filter(l => l !== ""); if (lines.length < 3) return;
        const season = lines[1]; if (!appData.seasons.includes(season)) appData.seasons.push(season);
        let currentClub = "Neznáme";
        for (let i = 2; i < lines.length; i++) {
            if (lines[i].toLowerCase().includes('klub :')) { currentClub = lines[i].split(':')[1].trim(); continue; }
            if (i + 4 < lines.length && !isNaN(lines[i+2].replace('-', '0'))) {
                let name = lines[i], pos = lines[i+1], apps = parseInt(lines[i+2]) || 0, goals = parseInt(lines[i+3]) || 0, assists = parseInt(lines[i+4]) || 0;
                if (!appData.players[name]) appData.players[name] = { name, history: [] };
                appData.players[name].history = appData.players[name].history.filter(h => h.season !== season);
                appData.players[name].history.push({ season, club: currentClub, pos, apps, goals, assists, yc: 0, rc: 0 }); 
                i += 4;
            }
        }
    }

    function saveToLocal() { localStorage.setItem('fifa_pro_data', JSON.stringify(appData)); }
    function renderAll() { renderFilters(); renderTable(); renderProSlots(); }
    function renderBackups() {
        const container = document.getElementById('backupListContainer'); container.innerHTML = '';
        if (!appData.backups || Object.keys(appData.backups).length === 0) { container.innerHTML = `<p style="text-align:center; color:#999;">Zatiaľ žiadne zálohy.</p>`; return; }
        Object.keys(appData.backups).sort().forEach(filename => { container.innerHTML += `<div class="backup-item"><span>${filename.replace('data','Sezóna ').replace('.txt','')}</span><button class="filter-btn" style="width:auto; background:var(--backup-color); color:white;" onclick="downloadBackup('${filename}')">STIAHNUŤ</button></div>`; });
    }
    function downloadBackup(filename) { const content = appData.backups[filename]; const blob = new Blob([content], {type: 'text/plain'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click(); }

    function renderProSlots() {
        const container = document.getElementById('proSlotsContainer'); container.innerHTML = '';
        for (let i = 1; i <= 4; i++) {
            const slotData = localStorage.getItem('pro_slot_' + i);
            container.innerHTML += `<div class="slot-card ${slotData ? 'filled' : 'empty'}">
                <div style="font-size:20px; font-weight:bold;">SLOT ${i}</div>
                <div class="slot-main-actions" style="display:flex; gap:10px; width:100%; margin-top:15px">
                    <div class="btn-slot-main" onclick="saveToSlot(${i})">ULOŽIŤ</div>
                    ${slotData ? `<div class="btn-slot-main" onclick="loadFromSlot(${i})">NAČÍTAŤ</div>` : `<div class="btn-slot-main" style="opacity:0.3;">---</div>`}
                </div>
                <div class="slot-sub-actions">
                    <div class="btn-slot-sub" onclick="downloadSlot(${i})">📥</div>
                    <div class="btn-slot-sub" onclick="triggerSlotUpload(${i})">📤</div>
                    <div class="btn-slot-sub" onclick="deleteSlot(${i})" style="${!slotData?'opacity:0.2':''}">🗑️</div>
                </div></div>`;
        }
    }
    function saveToSlot(i) { if (confirm("Uložiť hru do slotu " + i + "?")) { localStorage.setItem('pro_slot_' + i, JSON.stringify(appData)); renderProSlots(); } }
    function loadFromSlot(i) { if (confirm("Načítať?")) { const loaded = localStorage.getItem('pro_slot_' + i); if(loaded) { appData = JSON.parse(loaded); saveToLocal(); renderAll(); closeModal('proMenuModal'); } } }
    function deleteSlot(i) { if(confirm("Zmazať slot?")) { localStorage.removeItem('pro_slot_' + i); renderProSlots(); } }
    function downloadSlot(i) { const d = localStorage.getItem('pro_slot_' + i); if(d) { const b = new Blob([d], {type:'text/plain'}); const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download=`SLOT_${i}.txt`; a.click(); } }
    function triggerSlotUpload(i) { currentUploadSlot = i; document.getElementById('slotUploadInput').click(); }
    document.getElementById('slotUploadInput').onchange = async(e)=>{ const t=await e.target.files[0].text(); localStorage.setItem('pro_slot_'+currentUploadSlot, t); renderProSlots(); };

    function openDocManager() { openModal('docManagerModal'); renderDocManager(); }
    function renderDocManager() {
        const c = document.getElementById('docManagerList'); c.innerHTML = '';
        appData.seasons.slice().sort().forEach(s => { c.innerHTML += `<div class="stat-card" style="padding:20px; font-weight:bold; display:flex; justify-content:space-between; background:white; margin-bottom:10px; border-radius:10px; border:1px solid #eee"><span>${s}</span><span style="color:red; cursor:pointer; font-size:30px" onclick="deleteSeason('${s}')">✕</span></div>`; });
    }
    function deleteSeason(sn) { if(confirm("Vymazať sezónu?")) { appData.seasons = appData.seasons.filter(s=>s!==sn); Object.keys(appData.players).forEach(p=>{ appData.players[p].history=appData.players[p].history.filter(h=>h.season!==sn); if(appData.players[p].history.length===0) delete appData.players[p]; }); if(appData.backups) delete appData.backups[`data${sn}.txt`]; saveToLocal(); renderAll(); renderDocManager(); } }
    function resetAll() { if(confirm("VYMAZAŤ CELÚ DATABÁZU?")) { appData={players:{},seasons:[],externalLink:"",backups:{}}; saveToLocal(); renderAll(); closeModal('settingsModal'); } }
    function openExternalLink() { if(appData.externalLink) window.open(appData.externalLink, '_blank'); }

    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("service-worker.js");
        });
    }
</script>
</body>
</html>
